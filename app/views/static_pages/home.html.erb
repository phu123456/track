
<style>
  .stationary {
    background-image:
      radial-gradient(
        circle,
        #fd2c2c, #b41212 12px, transparent 12px
      );
  }

  .moving1 {
    background-image:
      radial-gradient(
        circle,
        #00ff00, green 12px, transparent 13px
      );
  }

  .moving2 {
    background-image:
      radial-gradient(
        circle,
        #90ff58, #4ad205 12px, transparent 13px
      );
  }


  .example-table {
      border-collapse: collapse;
      margin: 0 auto;
      border: 2px solid black;
      width: auto;

  }
  .example-thead {
      background-color: #333;
      color: #fff;
  }
  thead,tbody {
      display: block;
  }
  th,td {
      padding: 4px;
      width: 125px;
      box-sizing: border-box;
  }
  .tbody {
    overflow: auto;
    height: 50vh;
  }
   .aaa {
    height : 90vh;
  }

  .following {
      height: auto;
      color: #ccc;
      border-bottom: 1px solid grey;
  }

</style>

<head>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
</head>
<div class="container-fluid">
      <div class="row pt-3 aaa">
        <nav class="col-sm-3 col-md-4 d-none d-sm-block bg-light" >
            <ul class="nav nav-tabs" id="myTab" role="tablist">
              <li class="nav-item">
                <a class="nav-link active normal-mode" id="real-time-tab" onclick="removeLine();" data-toggle="tab" role="tab" aria-controls="home" aria-selected="true">Real Time</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="history-tab" data-toggle="tab" role="tab" aria-controls="profile" aria-selected="false">History</a>
              </li>
            </ul>

            <div id="real-time">
              <div class="following">
                <table class="table-top">
                      <tr align="center">
                          <th>Plate</th>
                          <th colspan="3">Location</th>
                          <th>Speed</th>
                      </tr>
                      <tr align="center">
                          <td>-</td>
                          <td></td>
                          <td>-</td>
                          <td></td>
                          <td>-</td>
                      </tr>
                </table>
              </div>
            <br>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
              <table class="example-table">
                  <thead class="example-thead">
                      <tr align="center">
                          <th> Plate </th>
                          <!-- <th> Location </th> -->
                          <th> Status </th>
                      </tr>
                      <tr align="center">
                          <th><input type="text" id="plate-search" size="9" style="height:23px;"></th>
                          <!-- <th><input type="text" id="province-search" size="13" style="height:23px;"></th> -->
                          <th><select id="selectBox" onchange="changeFunc();">
                              <option selected value="saab">All</option>
                              <option value="mercedes">Moving</option>
                              <option value="audi">Stationary</option>
                            </select>
                          </th>
                      </tr>
                  </thead>
                  <tbody class="data-table tbody">
                    <% @vehicles.each do |vehicle| %>
                    <tr style="background-color: white; border-bottom: 1px solid black;" align="center" >
                      <td><i class="fa fa-search" style="color:blue;text-shadow:2px 2px 4px #000000;" onclick="vehicleSearch(this)" id="<%= vehicle.id %>"></i> <%= vehicle.plate %></td>
                      <td class="status stationary"></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>






      <!-- <div class="history">
        haha
      </div> -->

      <div id="history" style="display:none;">
        <br>
            <select id="plate"style="width:115px;" class="js-example-basic-single" name="state">
                <% @vehicles.each do |vehicle| %>
                  <option value="<%= vehicle.id %>"> <%= vehicle.plate %> </option>
                <% end %>
              </select>
              <button onclick="vehicleSearch()" class="search-button">Search</button>
              <input type="datetime-local" id="startDate" >
              <br>
              <font align="center">ถึง</font>
              <br>
              <input id="endDate" type="datetime-local" >
            <br>
          <button class="search-button clear-marker" >Clear Markers</button>
        <button class="search-button normal-mode" onclick="removeLine();" >Normal Mode</button>
      </div>



</nav>
<main class="col-sm-6 ml-sm-auto col-md-8" role="main">
  <div id="dvMap" style="width: 100%; height: 100%"></div>
  </main>
</div>
</div>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script src="../../../../assets/js/vendor/jquery.min.js"><\/script>')</script>
<!-- <script src="../../../../assets/js/vendor/popper.min.js"></script>
<script src="../../../../dist/js/bootstrap-material-design.min.js"></script>
<script src="../../../../assets/js/ie10-viewport-bug-workaround.js"></script> -->

<script>
// window.onload = function () {
//   LoadMap()
// };
$(document).ready(function() {
  LoadMap()
  $('.fa-search').css( 'cursor', 'pointer' );
});

// document.getElementsByClassName("status").removeClass("stationary");
// document.getElementsByClassName("status").classList.add("moving2");

function vehicleSearch(obj) {
  vehicle_id = obj.id
  for (i = 0; i < markersArray.length; i++) {
    if (markersArray[i].name[0] == vehicle_id) {
        map.setZoom(13);
        map.setCenter(markersArray[i].getPosition());        
    }
  }
}
var output = $('#txt');
  var isPaused = false;
  var time = 0;
  var flightPath;
  var flightPathArray = [];
  $(".clear-marker").click(function(e) {
    var startDate = document.getElementById("startDate").value
    var endDate = document.getElementById("endDate").value
    vehicle_id = document.getElementById("plate").value
    e.preventDefault();
    isPaused = true;
    clearMarker()
    $.ajax({
      type:"GET",
      url:"/positions/routes",
      data: {
        id: vehicle_id,
        startDate: startDate,
        endDate: endDate
      },
      dataType:"json",
      success: function(data){
        // console.log("---here---")
        console.log(data)
        var pathCoordinates = data
        // console.log(data[1], (data[0]).length, data[2])
        flightPath = new google.maps.Polyline({
          path: pathCoordinates[0],
          icons: [{
            icon: lineSymbol,
            offset: '50%'
          }],
          geodesic: true,
          strokeColor: '#FF0000',
          strokeOpacity: 1.0,
          strokeWeight: 2
        });
        animateCircle(flightPath);
        flightPath.setMap(map);
        flightPathArray.push(flightPath);
      }
    });
  });

  $(".normal-mode").click(function(e) {
    isPaused = false;
  });


  var markersArray = [];
  var map;
  function LoadMap() {
    var mapOptions = {
        center: new google.maps.LatLng(14.5829178, 100.8755719),
        zoom: 6,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("dvMap"), mapOptions);
    placeMarker()
  };

  // console.log(map)

  function clearMarker() {
    for (var i = 0; i < markersArray.length; i++ ) {
      markersArray[i].setMap(null);
    }
  }

  var t = window.setInterval(function(){
    if(!isPaused) {
      time++;
      output.text("Seconds: " + time);
      clearMarker()
      markersArray.length = 0;
      placeMarker()
    }
  }, 16000 );

  function placeMarker() {
    $.ajax({
      type:"GET",
      url:"/positions/marker",
      dataType:"json",
      success: function(data){
        console.log(data)
        var markers = data
        for( i = 0; i < markers.length; i++ ) {
          var position = new google.maps.LatLng(markers[i][2], markers[i][3]);
          marker = new google.maps.Marker({
              position: position,
              name: [markers[i][0], markers[i][1]],
              icon: "http://maps.google.com/mapfiles/kml/shapes/truck.png",
              // label: {text: markers[i][0], color: "red"},
              map: map,
          });
          markersArray.push(marker);
        }
      }
    });
  }

  function removeLine() {

     for (var i = 0; i < flightPathArray.length; i++ ) {
       flightPathArray[i].setMap(null);
     }
   }

   var lineSymbol = {
     path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
     scale: 5,
     strokeWeight:2,
     strokeColor: '#393',
   };

   function animateCircle(line) {
        var count = 0;
        window.setInterval(function() {
          count = (count + 1) % 200;

          var icons = line.get('icons');
          icons[0].offset = (count / 2) + '%';
          line.set('icons', icons);
      }, 20);
    }

    $('#real-time-tab').click(function() {
      $("#history").hide();
      $("#real-time").show();
    })

    $('#history-tab').click(function() {
      $("#real-time").hide();
      $("#history").show();
    })

    $("#plate-search").keyup(function() {
      var value = this.value;
      $(".data-table").find("tr").each(function(index) {
          if (index === -1) return;
          var id = $(this).find("td").first().text();
          $(this).toggle(id.indexOf(value) !== -1);
      });
    });

    $("#province-search").keyup(function() {
      var value = this.value;
      $(".data-table").find("tr").each(function(index) {
          if (index === -1) return;
          var id = $(this).find("td")[1].innerText;
          $(this).toggle(id.indexOf(value) !== -1);
      });
    });

  //   function changeFunc() {
  //   var selectBox = document.getElementById("selectBox");
  //   var selectedValue = selectBox.options[selectBox.selectedIndex].value;
  //   alert(selectedValue);
  //  }
  //   $("#province-search").keyup(function() {
   //
  //   });

</script>
